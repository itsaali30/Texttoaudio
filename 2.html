<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Text to Speech with Google Sheets</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="app" class="container p-4">
  <h2 class="mb-4">Text to Speech with Google Sheets</h2>
  
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Google Sheet Configuration</h5>
      <div class="mb-3">
        <label class="form-label">Google Sheet ID</label>
        <input v-model="sheetId" type="text" class="form-control" placeholder="Paste your Google Sheet ID">
        <small class="form-text text-muted">Share sheet publicly, copy ID from URL</small>
      </div>
      
      <div class="mb-3">
        <label class="form-label">Sheet Name (Tab)</label>
        <input v-model="sheetName" type="text" class="form-control" placeholder="e.g., Sheet1" value="Sheet1">
      </div>
      
      <div class="mb-3">
        <label class="form-label">Column Letter</label>
        <input v-model="columnLetter" type="text" class="form-control" placeholder="e.g., A, B, C" maxlength="3" value="A">
      </div>
      
      <div class="mb-3">
        <label class="form-label">Language</label>
        <select v-model="lang" class="form-select">
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="hi-IN">Hindi (India)</option>
          <option value="fr-FR">French</option>
          <option value="es-ES">Spanish</option>
        </select>
      </div>
      
      <button @click="fetchAndProcess" class="btn btn-primary" :disabled="loading">
        {{ loading ? 'Processing...' : 'Start Processing' }}
      </button>
    </div>
  </div>
  
  <div v-if="status" class="alert" :class="status.type">
    {{ status.message }}
  </div>
  
  <div v-if="items.length > 0" class="card">
    <div class="card-body">
      <h5 class="card-title">Processing Queue</h5>
      <div class="progress mb-3">
        <div class="progress-bar" :style="{ width: progressPercent + '%' }">
          {{ progressPercent }}%
        </div>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        <div v-for="(item, index) in items" :key="index" class="mb-2 p-2 border rounded">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>Row {{ item.row }}:</strong> {{ item.text.substring(0, 50) }}...
            </div>
            <span class="badge" :class="statusBadge(item.status)">
              {{ item.status }}
            </span>
          </div>
          <small v-if="item.error" class="text-danger d-block mt-1">{{ item.error }}</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

createApp({
  setup() {
    const sheetId = ref("");
    const sheetName = ref("Sheet1");
    const columnLetter = ref("A");
    const lang = ref("en-US");
    const loading = ref(false);
    const items = ref([]);
    const status = ref(null);
    
    const progressPercent = computed(() => {
      if (items.value.length === 0) return 0;
      const completed = items.value.filter(i => i.status === 'completed' || i.status === 'error').length;
      return Math.round((completed / items.value.length) * 100);
    });
    
    const statusBadge = (st) => {
      if (st === 'completed') return 'bg-success';
      if (st === 'error') return 'bg-danger';
      if (st === 'processing') return 'bg-warning';
      return 'bg-secondary';
    };
    
    const fetchAndProcess = async () => {
      if (!sheetId.value || !columnLetter.value) {
        status.value = { type: 'alert-danger', message: 'Please enter Sheet ID and Column Letter' };
        return;
      }
      
      loading.value = true;
      status.value = { type: 'alert-info', message: 'Fetching data from Google Sheet...' };
      items.value = [];
      
      try {
        const range = `${sheetName.value}!${columnLetter.value}:${columnLetter.value}`;
        const url = `https://docs.google.com/spreadsheets/d/${sheetId.value}/gviz/query?tq=SELECT * WHERE A is not null&gid=0&tqx=out:json`;
        
        // Fetch using CORS-friendly method
        const response = await axios.get(url);
        const data = response.data;
        
        // Parse response
        const jsonMatch = data.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
        if (!jsonMatch) throw new Error('Invalid response from Google Sheets');
        
        const parsedData = JSON.parse(jsonMatch[1]);
        const rows = parsedData.table?.rows || [];
        
        if (rows.length === 0) throw new Error('No data found in column');
        
        // Extract text from column
        items.value = rows.map((row, index) => ({
          row: index + 1,
          text: row.c[0]?.v || '',
          status: 'pending',
          error: null,
          filename: `speech_${index + 1}.webm`
        })).filter(item => item.text.trim() !== '');
        
        status.value = { type: 'alert-info', message: `Found ${items.value.length} items. Starting conversion...` };
        
        // Process items one by one
        for (let i = 0; i < items.value.length; i++) {
          await processItem(i);
        }
        
        status.value = { type: 'alert-success', message: 'All items processed successfully!' };
      } catch (err) {
        status.value = { type: 'alert-danger', message: `Error: ${err.message}` };
      } finally {
        loading.value = false;
      }
    };
    
    const processItem = (index) => {
      return new Promise((resolve) => {
        const item = items.value[index];
        item.status = 'processing';
        
        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(item.text);
        utter.lang = lang.value;
        
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const dest = audioContext.createMediaStreamDestination();
        const recorder = new MediaRecorder(dest.stream);
        const chunks = [];
        
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          try {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            
            // Auto-download
            const a = document.createElement("a");
            a.href = url;
            a.download = item.filename;
            a.click();
            
            item.status = 'completed';
            setTimeout(resolve, 500);
          } catch (err) {
            item.status = 'error';
            item.error = err.message;
            setTimeout(resolve, 500);
          }
        };
        
        try {
          const source = audioContext.createMediaStreamSource(dest.stream);
          source.connect(audioContext.destination);
          recorder.start();
          synth.speak(utter);
          
          utter.onend = () => {
            recorder.stop();
          };
          
          utter.onerror = (e) => {
            recorder.stop();
            item.status = 'error';
            item.error = e.error;
            setTimeout(resolve, 500);
          };
        } catch (err) {
          item.status = 'error';
          item.error = err.message;
          setTimeout(resolve, 500);
        }
      });
    };
    
    return {
      sheetId,
      sheetName,
      columnLetter,
      lang,
      loading,
      items,
      status,
      progressPercent,
      statusBadge,
      fetchAndProcess
    };
  }
}).mount("#app");
</script>
</body>
</html>
